<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم سبورت شوب - Firebase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            direction: 'rtl',
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#059669',
                        accent: '#dc2626',
                        success: '#10b981',
                        warning: '#f59e0b',
                        info: '#3b82f6'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }
        .sidebar {
            transition: all 0.3s ease;
            transform: translateX(-100%);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 50;
            width: 280px;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .status-modification-approved { 
            background-color: #dbeafe; 
            color: #1e40af; 
        }
        .overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .main-content {
            transition: margin-right 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .product-card:hover {
            transform: scale(1.02);
        }
        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .status-processing { background-color: #fef3c7; color: #d97706; }
        .status-shipped { background-color: #dbeafe; color: #2563eb; }
        .status-delivered { background-color: #dcfce7; color: #16a34a; }
        .status-cancelled { background-color: #fee2e2; color: #dc2626; }
        .status-modification-requested { background-color: #ffedd5; color: #c2410c; }
        .chart-container {
            height: 250px;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .login-container {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #1e40af 0%, #059669 100%);
        }
        .login-form {
            width: 100%;
            max-width: 450px;
            padding: 1.5rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            margin: auto;
        }
        .login-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .login-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }
        .login-header p {
            color: #64748b;
            font-size: 0.9rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334155;
            font-size: 0.95rem;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(to right, #1e40af, #059669);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(to right, #1d4ed8, #047857);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            color: #64748b;
            font-size: 0.85rem;
        }
        .hidden {
            display: none !important;
        }
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #1e40af 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
        }
        .mobile-menu-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #334155;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        .spec-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .spec-row input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .spec-remove {
            background-color: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 0.375rem;
            width: 30px;
            cursor: pointer;
        }
        @media (max-width: 768px) {
            .sidebar { width: 260px; }
            .login-form { padding: 1.25rem; margin: 1rem; }
            .login-header h1 { font-size: 1.35rem; }
            .stat-card { padding: 1rem; }
            .stat-card .text-2xl { font-size: 1.5rem; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important; }
            .chart-container { height: 200px; }
            .modal-content { margin: 1rem; padding: 1rem; }
            .modal-title { font-size: 1.25rem; }
            .order-items { max-height: 180px; }
        }
        @media (max-width: 480px) {
            .login-form { margin: 0.5rem; padding: 1rem; }
            .logo { width: 60px; height: 60px; font-size: 1.5rem; }
            .login-header h1 { font-size: 1.25rem; }
            .stat-grid { grid-template-columns: 1fr !important; }
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important; }
            .chart-container { height: 180px; }
        }
        .w-15 { width: 60px; }
        .h-15 { height: 60px; }
        #orders-list .order-status {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 600;
        }
        #orders-list img {
            min-width: 60px;
            min-height: 60px;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- واجهة تسجيل الدخول -->
    <div id="login-screen" class="login-container">
        <div class="login-form">
            <div class="logo-container">
                <div class="logo">S</div>
            </div>
            <div class="login-header">
                <h1>مرحباً بك في سبورت شوب</h1>
                <p>سجل الدخول لإدارة متجرك</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">البريد الإلكتروني</label>
                    <input type="email" id="email" class="form-control" placeholder="أدخل بريدك الإلكتروني" required>
                </div>
                <div class="form-group">
                    <label for="password">كلمة المرور</label>
                    <input type="password" id="password" class="form-control" placeholder="أدخل كلمة المرور" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt ml-2"></i> تسجيل الدخول
                </button>
            </form>
            <div class="login-footer">
                <p>© 2023 سبورت شوب. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </div>
    <!-- المحتوى الرئيسي (مخفي افتراضيًا) -->
    <div id="main-content" class="hidden">
        <!-- شريط التنقل -->
        <nav class="bg-white shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center">
                        <button class="mobile-menu-button" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 w-8 h-8 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">S</span>
                        </div>
                        <span class="mr-2 text-base font-bold text-gray-800 md:mr-3 md:text-xl">سبورت شوب</span>
                    </div>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <span id="admin-email" class="text-gray-700 hidden md:inline text-sm md:text-base"></span>
                        <button onclick="logout()" class="p-1.5 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-sign-out-alt text-lg md:text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        <!-- الشريط الجانبي -->
        <div id="sidebar" class="sidebar bg-white shadow-lg">
            <div class="p-4 pt-6">
                <div class="flex justify-between items-center mb-6">
                    <div class="text-center">
                        <div class="mx-auto bg-gradient-to-r from-blue-600 to-purple-600 w-12 h-12 rounded-full flex items-center justify-center text-white text-lg font-bold mb-2">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3 class="font-bold text-gray-800 text-sm">مدير النظام</h3>
                    </div>
                    <button class="text-gray-500 hover:text-gray-700" onclick="toggleSidebar()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <nav>
                    <ul class="space-y-1">
                        <li><button onclick="showSection('dashboard')" class="w-full text-right px-3 py-2.5 rounded-lg bg-blue-50 text-blue-700 font-medium flex items-center justify-between text-sm"><span>لوحة التحكم</span><i class="fas fa-tachometer-alt"></i></button></li>
                        <li><button onclick="showSection('products')" class="w-full text-right px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 font-medium flex items-center justify-between text-sm"><span>إدارة المنتجات</span><i class="fas fa-tshirt"></i></button></li>
                        <li><button onclick="showSection('orders')" class="w-full text-right px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 font-medium flex items-center justify-between text-sm"><span>إدارة الطلبات</span><i class="fas fa-shopping-cart"></i></button></li>
                        <li><button onclick="showSection('analytics')" class="w-full text-right px-3 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100 font-medium flex items-center justify-between text-sm"><span>تحليل المبيعات</span><i class="fas fa-chart-pie"></i></button></li>
                    </ul>
                </nav>
            </div>
        </div>
        <!-- تراكب الشريط الجانبي -->
        <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>
        <!-- المحتوى الرئيسي -->
        <div class="main-content p-4 md:p-6">
            <div id="dashboard-section" class="space-y-4 md:space-y-6">
                <div class="stat-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                    <div class="stat-card bg-white p-4 md:p-6 rounded-xl shadow">
                        <div class="flex items-center">
                            <div class="p-2.5 md:p-3 bg-blue-100 rounded-lg"><i class="fas fa-shopping-cart text-blue-600 text-lg md:text-xl"></i></div>
                            <div class="mr-3 md:mr-4">
                                <p class="text-gray-500 text-xs md:text-sm">إجمالي الطلبات</p>
                                <p class="text-xl md:text-2xl font-bold text-gray-800" id="total-orders">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card bg-white p-4 md:p-6 rounded-xl shadow">
                        <div class="flex items-center">
                            <div class="p-2.5 md:p-3 bg-green-100 rounded-lg"><i class="fas fa-money-bill-wave text-green-600 text-lg md:text-xl"></i></div>
                            <div class="mr-3 md:mr-4">
                                <p class="text-gray-500 text-xs md:text-sm">إجمالي المبيعات</p>
                                <p class="text-xl md:text-2xl font-bold text-gray-800" id="total-sales">0 ع.د</p>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card bg-white p-4 md:p-6 rounded-xl shadow">
                        <div class="flex items-center">
                            <div class="p-2.5 md:p-3 bg-purple-100 rounded-lg"><i class="fas fa-tshirt text-purple-600 text-lg md:text-xl"></i></div>
                            <div class="mr-3 md:mr-4">
                                <p class="text-gray-500 text-xs md:text-sm">عدد المنتجات</p>
                                <p class="text-xl md:text-2xl font-bold text-gray-800" id="total-products">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl shadow">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 mb-3 md:mb-4">آخر الطلبات</h3>
                    <div class="table-responsive">
                        <table class="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">المنتج</th>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">الطلب</th>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">العميل</th>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">المبلغ</th>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">الحالة</th>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">التاريخ</th>
                                </tr>
                            </thead>
                            <tbody id="recent-orders"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- إدارة المنتجات -->
            <div id="products-section" class="space-y-4 md:space-y-6 hidden">
                <div class="flex justify-between items-center flex-wrap gap-3">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">إدارة المنتجات</h2>
                    <button onclick="openAddProductModal()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-3 py-2 md:px-4 md:py-2 rounded-lg text-sm md:text-base">
                        <i class="fas fa-plus ml-1 md:ml-2"></i>إضافة منتج
                    </button>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl shadow">
                    <div class="product-grid grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="products-grid"></div>
                </div>
            </div>
            <!-- ✅ إدارة الطلبات -->
            <div id="orders-section" class="space-y-4 md:space-y-6 hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">إدارة الطلبات</h2>
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div id="orders-list" class="divide-y divide-gray-100"></div>
                </div>
            </div>
            <!-- تحليل المبيعات -->
            <div id="analytics-section" class="space-y-4 md:space-y-6 hidden">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">تحليل المبيعات</h2>
                <div class="bg-white p-4 md:p-6 rounded-xl shadow">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 mb-3 md:mb-4">أكثر المنتجات طلبًا</h3>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-xl shadow">
                    <h3 class="text-base md:text-lg font-bold text-gray-800 mb-3 md:mb-4">تفاصيل المبيعات حسب الفئة</h3>
                    <div class="table-responsive">
                        <table class="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">الفئة</th>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">القطع المباعة</th>
                                    <th class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase">إجمالي المبيعات</th>
                                </tr>
                            </thead>
                            <tbody id="category-sales-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- نافذة إضافة منتج -->
        <div id="productModal" class="fixed inset-0 overflow-y-auto z-50 hidden">
            <div class="flex items-center justify-center min-h-screen">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="closeProductModal()"></div>
                <div class="bg-white rounded-lg p-4 md:p-6 w-full max-w-md mx-4 modal-content relative">
                    <button onclick="closeProductModal()" class="absolute top-3 right-3 text-gray-500"><i class="fas fa-times"></i></button>
                    <h3 class="text-base md:text-xl font-bold mb-3 md:mb-4 text-right modal-title">إضافة منتج جديد</h3>
                    <div class="space-y-3 md:space-y-4 text-right">
                        <input type="text" id="productName" placeholder="اسم المنتج" class="w-full p-2 border rounded text-sm md:text-base">
                        <select id="productCategory" class="w-full p-2 border rounded text-sm md:text-base">
                            <option value="كرة القدم">كرة القدم</option>
                            <option value="الجري">الجري</option>
                            <option value="اليوجا">اليوجا</option>
                            <option value="كمال الأجسام">كمال الأجسام</option>
                        </select>
                        <input type="number" id="productQuantity" placeholder="الكمية المتوفرة" class="w-full p-2 border rounded text-sm md:text-base" min="0" value="0">
                        <input type="number" id="productPrice" placeholder="السعر" class="w-full p-2 border rounded text-sm md:text-base" step="0.01">
                        <textarea id="productDescription" placeholder="الوصف" class="w-full p-2 border rounded text-sm md:text-base" rows="2"></textarea>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-right text-sm">المواصفات</label>
                                <button type="button" onclick="addSpecRow()" class="text-blue-600 text-xs">+ إضافة مواصفة</button>
                            </div>
                            <div id="specs-container" class="space-y-2"></div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-right mb-2 text-sm">رفع صورة المنتج</label>
                            <input type="file" id="productImage" accept="image/*" class="w-full p-2 border rounded text-sm">
                            <img id="image-preview" class="mt-2 w-24 h-24 md:w-32 md:h-32 object-cover rounded hidden">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="productInStock" checked class="ml-2">
                            <label for="productInStock" class="text-sm">متوفر في المخزن</label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2 space-x-reverse mt-4">
                        <button onclick="saveProduct()" class="bg-blue-600 text-white px-3 py-2 md:px-4 md:py-2 rounded text-sm md:text-base">حفظ</button>
                        <button onclick="closeProductModal()" class="bg-gray-300 px-3 py-2 md:px-4 md:py-2 rounded text-sm md:text-base">إلغاء</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ✅ نافذة تفاصيل الطلب (محدثة) -->
        <div id="orderModal" class="fixed inset-0 overflow-y-auto z-50 hidden">
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeOrderModal()"></div>
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:mt-0 sm:mr-4 sm:text-right w-full">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-base md:text-lg leading-6 font-medium text-gray-900 modal-title">تفاصيل الطلب #<span id="order-number">12345</span></h3>
                                    <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-500">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <h4 class="font-medium text-gray-900 mb-2 text-sm">معلومات العميل</h4>
                                    <div class="bg-gray-50 p-2 md:p-3 rounded-md text-xs md:text-sm">
                                        <p><strong>الاسم:</strong> <span id="customer-name">---</span></p>
                                        <p><strong>الهاتف:</strong> <span id="customer-phone">---</span></p>
                                        <p><strong>العنوان:</strong> <span id="customer-address">---</span></p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <h4 class="font-medium text-gray-900 mb-2 text-sm">تفاصيل الطلب</h4>
                                    <div id="order-items" class="bg-gray-50 p-2 md:p-3 rounded-md order-items overflow-y-auto text-xs md:text-sm">
                                    </div>
                                </div>
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                                    <div class="text-base font-bold text-gray-900">
                                        المجموع: <span id="order-total">0.00</span> ع.د
                                    </div>
                                    <div class="w-full md:w-auto">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">تحديث الحالة</label>
                                        <select id="order-status" class="border border-gray-300 rounded-md px-2 py-1 w-full md:w-auto text-xs md:text-sm">
                                            <option value="processing">قيد المعالجة</option>
                                            <option value="modification-requested">طلب تعديل</option>
                                            <option value="modification-approved">مسموح بالتعديل</option>
                                            <option value="shipped">تم الشحن</option>
                                            <option value="delivered">تم التسليم</option>
                                            <option value="cancelled">ملغى</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- ✅ زر "تعديل الطلب" -->
                                <div class="flex justify-end mt-3">
                                    <!-- زر التعديل يظهر فقط عند حالة "مسموح بالتعديل" -->
                                    <button id="edit-order-button" 
                                            onclick="openEditOrderModal(currentOrder.id)"
                                            class="px-3 py-1.5 md:px-4 md:py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-xs md:text-sm ml-2 hidden">
                                        تعديل الطلب
                                    </button>
                                    <button onclick="updateOrderStatus()" class="px-3 py-1.5 md:px-4 md:py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-xs md:text-sm">
                                        تحديث الحالة
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- نافذة تعديل الطلب -->
        <div id="editOrderModal" class="fixed inset-0 overflow-y-auto z-50 hidden">
            <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeEditOrderModal()"></div>
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:mt-0 sm:mr-4 sm:text-right w-full">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-base md:text-lg leading-6 font-medium text-gray-900">تعديل الطلب #<span id="edit-order-number"></span></h3>
                                    <button onclick="closeEditOrderModal()" class="text-gray-400 hover:text-gray-500">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div id="edit-order-items" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
                                <button onclick="showProductSelector()" class="w-full py-1.5 text-sm text-blue-600 border border-blue-300 rounded-md hover:bg-blue-50 mb-4">
                                    + إضافة منتج من المتجر
                                </button>
                                <div id="product-selector" class="hidden mb-4">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">اختر منتجًا:</label>
                                    <select id="new-product-select" class="w-full p-2 border rounded text-sm"></select>
                                    <div class="flex gap-2 mt-2">
                                        <input type="number" id="new-product-qty" min="1" value="1" class="w-20 p-1 border rounded text-center text-xs" placeholder="الكمية">
                                        <button onclick="addProductToOrder()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">إضافة</button>
                                        <button onclick="hideProductSelector()" class="px-3 py-1 bg-gray-300 rounded text-xs">إلغاء</button>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button onclick="saveOrderChanges()" class="px-3 py-1.5 md:px-4 md:py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-xs md:text-sm">
                                        حفظ التعديلات
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-check-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAoA2VrcSW9Rdpsl2qDKPDRrpr7RxLVZ64",
            authDomain: "xxsfv-1222e.firebaseapp.com",
            projectId: "xxsfv-1222e",
            storageBucket: "xxsfv-1222e.firebasestorage.app",
            messagingSenderId: "1082133530646",
            appId: "1:1082133530646:web:fbe13cf3179720308e4d37"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appCheck = firebase.appCheck();
        appCheck.activate('6LcexwUsAAAAABH6pgqOU2uAiNPTpRVMhuYILUJH', true);
        const ALLOWED_ADMINS = ["admin@sportshop.com"];
        function isAdmin(user) {
            return user && ALLOWED_ADMINS.includes(user.email);
        }
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user && isAdmin(user)) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('admin-email').textContent = user.email;
                    loadDashboardData();
                    renderProducts();
                    renderOrders();
                    showSection('dashboard');
                    startAutoRefresh();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    if (user) {
                        alert("ليس لديك صلاحية الوصول إلى لوحة التحكم.");
                        auth.signOut();
                    }
                }
            });
        }
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('خطأ في تسجيل الدخول: ' + error.message);
            }
        });
        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                auth.signOut();
            }
        }
        function checkPermission() {
            const user = auth.currentUser;
            if (!user || !isAdmin(user)) {
                alert("غير مصرح لك بإجراء هذا الإجراء.");
                return false;
            }
            return true;
        }
        function addSpecRow(key = '', value = '') {
            const container = document.getElementById('specs-container');
            const div = document.createElement('div');
            div.className = 'spec-row';
            div.innerHTML = `
                <input type="text" placeholder="الاسم (مثل: اللون)" value="${key}" class="flex-1 text-sm" />
                <input type="text" placeholder="القيمة (مثل: أحمر)" value="${value}" class="flex-1 text-sm" />
                <button type="button" class="spec-remove" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(div);
        }
        async function saveProduct() {
            if (!checkPermission()) return;
            const name = document.getElementById('productName').value.trim();
            const category = document.getElementById('productCategory').value;
            const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
            const price = parseFloat(document.getElementById('productPrice').value);
            const description = document.getElementById('productDescription').value;
            const inStock = document.getElementById('productInStock').checked;
            const imageFile = document.getElementById('productImage').files[0];
            if (!name || !category || isNaN(price)) return alert('يرجى تعبئة الحقول');
            let imageBase64 = null;
            if (imageFile) {
                try {
                    imageBase64 = await compressImage(imageFile, 0.7, 800, 800);
                } catch (err) {
                    alert('خطأ في معالجة الصورة');
                    return;
                }
            }
            const specRows = document.querySelectorAll('#specs-container .spec-row');
            const specifications = {};
            specRows.forEach(row => {
                const keyInput = row.children[0];
                const valueInput = row.children[1];
                const key = keyInput.value.trim();
                const value = valueInput.value.trim();
                if (key && value) {
                    specifications[key] = value;
                }
            });
            const product = { name, category, quantity, price, description, inStock, image: imageBase64 || null, specifications };
            if (editingProductId) {
                await db.collection('products').doc(editingProductId).update(product);
            } else {
                await db.collection('products').add(product);
            }
            renderProducts();
            closeProductModal();
        }
        async function deleteProduct(id) {
            if (!checkPermission()) return;
            if (confirm('حذف المنتج؟')) {
                await db.collection('products').doc(id).delete();
                renderProducts();
            }
        }
        async function updateOrderStatus() {
            if (!checkPermission()) return;
            if (!currentOrder) return;
            const newStatus = document.getElementById('order-status').value;
            await db.collection('orders').doc(currentOrder.id).update({ status: newStatus });
            renderOrders();
            loadDashboardData();
            renderRecentOrders();
            if (currentSection === 'analytics') loadSalesAnalytics();
            closeOrderModal();
            alert('تم تحديث الحالة!');
        }
        let currentSection = 'dashboard';
        let editingProductId = null;
        let currentOrder = null;
        let autoRefreshInterval = null;
        let salesChart = null;
        let editingOrder = null;
        function formatDateTime12Hour(timestamp) {
            if (!timestamp) return '---';
            const date = timestamp.toDate();
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            }).replace(',', '');
        }
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('image-preview').src = event.target.result;
                    document.getElementById('image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });
        function compressImage(file, quality = 0.7, maxWidth = 800, maxHeight = 800) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    let { width, height } = img;
                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round(height * maxWidth / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = Math.round(width * maxHeight / height);
                            height = maxHeight;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(blob => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    }, 'image/jpeg', quality);
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
        function showSection(section) {
            document.querySelectorAll('[id$="-section"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');
            currentSection = section;
            closeSidebar();
            document.querySelectorAll('#sidebar button').forEach(btn => {
                btn.classList.remove('bg-blue-50', 'text-blue-700', 'font-bold');
            });
            const activeBtn = document.querySelector(`#sidebar button[onclick="showSection('${section}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-blue-50', 'text-blue-700', 'font-bold');
            }
            if (section === 'analytics') {
                loadSalesAnalytics();
            }
        }
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                if (currentSection === 'dashboard') {
                    loadDashboardData();
                    renderRecentOrders();
                } else if (currentSection === 'orders') {
                    renderOrders();
                } else if (currentSection === 'analytics') {
                    loadSalesAnalytics();
                }
            }, 5000);
        }
        async function loadDashboardData() {
            const productsSnap = await db.collection('products').get();
            const ordersSnap = await db.collection('orders')
                .where('status', 'in', ['shipped', 'delivered'])
                .get();
            document.getElementById('total-products').textContent = productsSnap.size;
            document.getElementById('total-orders').textContent = ordersSnap.size;
            let totalSales = 0;
            ordersSnap.forEach(doc => {
                const order = doc.data();
                totalSales += order.total || 0;
            });
            document.getElementById('total-sales').textContent = totalSales.toLocaleString('ar-SA') + ' ع.د';
        }
        async function renderRecentOrders() {
            const tbody = document.getElementById('recent-orders');
            const snap = await db.collection('orders').orderBy('date', 'desc').limit(5).get();
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const o = doc.data();
                const firstItem = o.items && o.items.length > 0 ? o.items[0] : null;
                const productImage = firstItem?.image || 'https://placehold.co/40x40?text=صورة';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap">
                        <img src="${productImage}" alt="صورة المنتج" class="w-6 h-6 md:w-8 md:h-8 object-cover rounded" onerror="this.src='https://placehold.co/40x40?text=لا+صورة'">
                    </td>
                    <td class="text-xs md:text-sm">#${doc.id}</td>
                    <td class="text-xs md:text-sm">${o.customerName || '---'}</td>
                    <td class="text-xs md:text-sm">${(o.total || 0).toFixed(2)} ع.د</td>
                    <td class="text-xs md:text-sm"><span class="order-status status-${o.status || 'processing'}">${getStatusText(o.status)}</span></td>
                    <td class="text-xs md:text-sm">${formatDateTime12Hour(o.date) || '---'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        async function renderProducts() {
            const productsGrid = document.getElementById('products-grid');
            const query = await db.collection('products').get();
            productsGrid.innerHTML = '';
            query.forEach(doc => {
                const p = doc.data();
                const card = document.createElement('div');
                card.className = 'product-card bg-white p-3 rounded-lg shadow text-center';
                const imgSrc = p.image || 'https://placehold.co/150x150';
                const specsHtml = p.specifications ? Object.entries(p.specifications).map(([k, v]) => `${k}: ${v}`).join(' | ') : '';
                const quantityText = p.quantity !== undefined ? `الكمية: ${p.quantity}` : '';
                card.innerHTML = `
                    <img src="${imgSrc}" class="w-full h-32 md:h-40 object-cover rounded-lg mb-2" onerror="this.src='https://placehold.co/150x150?text=لا+صورة'">
                    <h3 class="font-bold text-gray-800 text-sm md:text-base mb-1">${p.name}</h3>
                    ${specsHtml ? `<p class="text-gray-500 text-xxs md:text-xs mb-1">${specsHtml}</p>` : ''}
                    <p class="text-gray-600 text-xs md:text-sm mb-2">${p.category}</p>
                    <p class="text-gray-500 text-xs">${quantityText}</p>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-blue-600 text-sm md:text-base">${(p.price || 0).toFixed(2)} ع.د</span>
                        <div class="flex space-x-1 space-x-reverse">
                            <button onclick="editProduct('${doc.id}')" class="text-blue-600 text-xs md:text-sm"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteProduct('${doc.id}')" class="text-red-600 text-xs md:text-sm"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                productsGrid.appendChild(card);
            });
        }
        function openAddProductModal() {
            editingProductId = null;
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('specs-container').innerHTML = '';
            document.getElementById('productModal').classList.remove('hidden');
        }
        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
        }
        async function editProduct(id) {
            editingProductId = id;
            const doc = await db.collection('products').doc(id).get();
            const p = doc.data();
            document.getElementById('productName').value = p.name;
            document.getElementById('productCategory').value = p.category;
            document.getElementById('productQuantity').value = p.quantity || 0;
            document.getElementById('productPrice').value = p.price;
            document.getElementById('productDescription').value = p.description || '';
            document.getElementById('productInStock').checked = p.inStock !== false;
            if (p.image) {
                document.getElementById('image-preview').src = p.image;
                document.getElementById('image-preview').classList.remove('hidden');
            } else {
                document.getElementById('image-preview').classList.add('hidden');
            }
            const specsContainer = document.getElementById('specs-container');
            specsContainer.innerHTML = '';
            if (p.specifications) {
                Object.entries(p.specifications).forEach(([key, value]) => {
                    addSpecRow(key, value);
                });
            }
            document.getElementById('productModal').classList.remove('hidden');
        }
        async function renderOrders() {
            const container = document.getElementById('orders-list');
            const snap = await db.collection('orders').orderBy('date', 'desc').get();
            container.innerHTML = '';
            if (snap.empty) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500">لا توجد طلبات حتى الآن.</div>`;
                return;
            }
            snap.forEach(doc => {
                const o = doc.data();
                const firstItem = o.items?.[0] || null;
                const productImage = firstItem?.image || 'https://placehold.co/60x60?text=صورة';
                const statusText = getStatusText(o.status);
                const statusClass = `status-${o.status || 'processing'}`;
                const orderEl = document.createElement('div');
                orderEl.className = 'p-4 cursor-pointer hover:bg-gray-50 transition-colors';
                orderEl.onclick = () => viewOrderDetails(doc.id);
                orderEl.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <img src="${productImage}" 
                                 alt="صورة المنتج"
                                 class="w-15 h-15 rounded-lg object-cover border border-gray-200"
                                 onerror="this.src='https://placehold.co/60x60?text=لا+صورة'">
                        </div>
                        <div class="flex-1 min-w-0 text-right">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-gray-900 text-sm">#${doc.id}</span>
                                <span class="order-status ${statusClass} text-xs px-2 py-1">${statusText}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${formatDateTime12Hour(o.date) || '---'}</p>
                            <p class="font-semibold text-gray-800 mt-1 text-sm">${(o.total || 0).toLocaleString('ar-SA')} ع.د</p>
                            <p class="text-xs text-blue-600 mt-1">اضغط لعرض التفاصيل</p>
                        </div>
                    </div>
                `;
                container.appendChild(orderEl);
            });
        }
        function getStatusText(status) {
            return ({
                'processing': 'قيد المعالجة',
                'modification-requested': 'طلب تعديل',
                'modification-approved': 'مسموح بالتعديل',
                'shipped': 'تم الشحن',
                'delivered': 'تم التسليم',
                'cancelled': 'ملغى'
            })[status] || status;
        }
        // ✅ دالة viewOrderDetails المحدثة
        async function viewOrderDetails(orderId) {
            const doc = await db.collection('orders').doc(orderId).get();
            if (!doc.exists) return;
            const order = doc.data();
            currentOrder = { id: doc.id, ...order };
            document.getElementById('order-number').textContent = doc.id;
            document.getElementById('customer-name').textContent = order.customerName || '---';
            document.getElementById('customer-phone').textContent = order.phone || '---';
            document.getElementById('customer-address').textContent = order.address || '---';
            document.getElementById('order-total').textContent = (order.total || 0).toFixed(2);
            document.getElementById('order-status').value = order.status || 'processing';
            const orderItems = document.getElementById('order-items');
            orderItems.innerHTML = (order.items || []).map(item => `
                <div class="flex justify-between py-1 items-center">
                    <div class="flex items-center">
                        <img src="${item.image || 'https://placehold.co/30x30?text=صورة'}" 
                             class="w-6 h-6 md:w-8 md:h-8 object-cover rounded mr-1 md:mr-2" 
                             onerror="this.src='https://placehold.co/30x30?text=لا+صورة'">
                        <span class="text-xs md:text-sm">${item.name} (x${item.quantity})</span>
                    </div>
                    <span class="text-xs md:text-sm">${((item.price || 0) * (item.quantity || 1)).toFixed(2)} ع.د</span>
                </div>
            `).join('');
            // ✅ التحكم في ظهور زر التعديل
            const editButton = document.getElementById('edit-order-button');
            if (order.status === 'modification-approved') {
                editButton.classList.remove('hidden');
            } else {
                editButton.classList.add('hidden');
            }
            document.getElementById('orderModal').classList.remove('hidden');
        }
        function closeOrderModal() {
            document.getElementById('orderModal').classList.add('hidden');
        }
        async function requestOrderModification(orderId) {
            if (!checkPermission()) return;
            const reason = prompt("أدخل سبب طلب التعديل (سيتم عرضه للعميل):");
            if (!reason) return;
            await db.collection('orders').doc(orderId).update({
                status: 'modification-requested',
                modificationRequested: true,
                modificationDetails: {
                    message: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                },
                modificationApproved: null
            });
            alert("تم إرسال طلب التعديل إلى العميل.");
            renderOrders();
        }
        function openEditOrderModal(orderId) {
            if (!checkPermission()) return;
            db.collection('orders').doc(orderId).get().then(doc => {
                if (!doc.exists) return;
                editingOrder = { id: doc.id, ...doc.data() };
                document.getElementById('edit-order-number').textContent = doc.id;
                renderEditOrderItems();
                document.getElementById('editOrderModal').classList.remove('hidden');
            });
        }
        function removeItemFromEdit(index) {
            if (!editingOrder || !editingOrder.items || index < 0 || index >= editingOrder.items.length) return;
            editingOrder.items.splice(index, 1);
            renderEditOrderItems();
        }
        function closeEditOrderModal() {
            document.getElementById('editOrderModal').classList.add('hidden');
        }
        async function saveOrderChanges() {
            if (!checkPermission() || !editingOrder || !editingOrder.items || editingOrder.items.length === 0) {
                alert("لا يمكن حفظ طلب فارغ.");
                return;
            }
            const items = [...editingOrder.items];
            const qtyInputs = document.querySelectorAll('.order-qty');
            const priceInputs = document.querySelectorAll('.order-price');
            let valid = true;
            for (let i = 0; i < qtyInputs.length; i++) {
                const qty = parseFloat(qtyInputs[i].value);
                const price = parseFloat(priceInputs[i].value);
                const maxQty = parseFloat(qtyInputs[i].getAttribute('data-max')) || Infinity;
                if (isNaN(qty) || qty <= 0 || isNaN(price) || price < 0) {
                    valid = false;
                }
                if (qty > maxQty) {
                    alert(`الكمية المدخلة لـ "${items[i].name}" تفوق الكمية المتوفرة (${maxQty}).`);
                    valid = false;
                }
                if (valid) {
                    items[i].quantity = qty;
                    items[i].price = price;
                }
            }
            if (!valid) return;
            const newTotal = items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            // ✅ معاملة Firestore لخصم الكميات وتحديث الطلب
            const batch = db.batch();
            const orderRef = db.collection('orders').doc(editingOrder.id);
            batch.update(orderRef, {
                items: items,
                total: newTotal,
                status: 'processing',
                modificationRequested: false,
                modificationApproved: false,
                lastModified: firebase.firestore.FieldValue.serverTimestamp()
            });
            // ✅ خصم الكميات من المنتجات
            for (const item of items) {
                if (item.id) {
                    const productRef = db.collection('products').doc(item.id);
                    const productSnap = await productRef.get();
                    if (productSnap.exists) {
                        const currentQty = productSnap.data().quantity || 0;
                        const newQty = Math.max(0, currentQty - item.quantity);
                        batch.update(productRef, { quantity: newQty });
                    }
                }
            }
            await batch.commit();
            alert("تم تحديث الطلب بنجاح!");
            closeEditOrderModal();
            renderOrders();
            if (currentSection === 'dashboard') renderRecentOrders();
            if (currentSection === 'analytics') loadSalesAnalytics();
        }
        async function loadSalesAnalytics() {
            const ordersSnap = await db.collection('orders')
                .where('status', 'in', ['shipped', 'delivered'])
                .get();
            const productSales = {};
            const categorySales = {};
            ordersSnap.forEach(doc => {
                const order = doc.data();
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        const productId = item.id || item.name;
                        if (!productSales[productId]) {
                            productSales[productId] = {
                                name: item.name || 'منتج غير معروف',
                                quantity: 0,
                                total: 0
                            };
                        }
                        productSales[productId].quantity += item.quantity || 1;
                        productSales[productId].total += (item.price || 0) * (item.quantity || 1);
                        const category = item.category || 'غير مصنف';
                        if (!categorySales[category]) {
                            categorySales[category] = {
                                quantity: 0,
                                total: 0
                            };
                        }
                        categorySales[category].quantity += item.quantity || 1;
                        categorySales[category].total += (item.price || 0) * (item.quantity || 1);
                    });
                }
            });
            renderSalesChart(productSales);
            renderCategorySalesTable(categorySales);
        }
        function renderSalesChart(productSales) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (salesChart) {
                salesChart.destroy();
            }
            const sortedProducts = Object.entries(productSales)
                .sort(([,a], [,b]) => b.quantity - a.quantity)
                .slice(0, 10);
            const labels = sortedProducts.map(([id, data]) => data.name);
            const quantities = sortedProducts.map(([id, data]) => data.quantity);
            const backgroundColors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#06b6d4', '#f97316', '#ec4899', '#14b8a6', '#6366f1'
            ];
            salesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: quantities,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true,
                            labels: {
                                font: {
                                    family: 'Tajawal',
                                    size: 10
                                },
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw} قطعة`;
                                }
                            }
                        }
                    }
                }
            });
        }
        function renderCategorySalesTable(categorySales) {
            const tbody = document.getElementById('category-sales-table');
            tbody.innerHTML = '';
            Object.entries(categorySales)
                .sort(([,a], [,b]) => b.quantity - a.quantity)
                .forEach(([category, data]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-xs md:text-sm">${category}</td>
                        <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-xs md:text-sm">${data.quantity}</td>
                        <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-xs md:text-sm">${data.total.toFixed(2)} ع.د</td>
                    `;
                    tbody.appendChild(row);
                });
        }
        async function showProductSelector() {
            const selector = document.getElementById('product-selector');
            const select = document.getElementById('new-product-select');
            select.innerHTML = '<option value="">جارٍ التحميل...</option>';
            selector.classList.remove('hidden');
            try {
                const snap = await db.collection('products').where('inStock', '==', true).get();
                select.innerHTML = '<option value="">اختر منتجًا</option>';
                snap.forEach(doc => {
                    const p = doc.data();
                    if (p.name && p.price !== undefined) {
                        const qtyText = p.quantity !== undefined ? ` (الكمية: ${p.quantity})` : '';
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = `${p.name} - ${p.price.toFixed(2)} ع.د${qtyText}`;
                        option.setAttribute('data-price', p.price);
                        option.setAttribute('data-name', p.name);
                        option.setAttribute('data-image', p.image || '');
                        option.setAttribute('data-quantity', p.quantity !== undefined ? p.quantity : '');
                        select.appendChild(option);
                    }
                });
            } catch (error) {
                console.error("خطأ في تحميل المنتجات:", error);
                select.innerHTML = '<option value="">خطأ في التحميل</option>';
            }
        }
        function hideProductSelector() {
            document.getElementById('product-selector').classList.add('hidden');
        }

        // ✅ الدالة المعدّلة لدمج العناصر المكررة
        function addProductToOrder() {
            const select = document.getElementById('new-product-select');
            const qtyInput = document.getElementById('new-product-qty');
            const productId = select.value;
            if (!productId) {
                alert("يرجى اختيار منتج.");
                return;
            }
            const option = select.options[select.selectedIndex];
            const name = option.getAttribute('data-name');
            const price = parseFloat(option.getAttribute('data-price'));
            const image = option.getAttribute('data-image');
            const maxQtyStr = option.getAttribute('data-quantity');
            let maxQty = Infinity;
            if (maxQtyStr && maxQtyStr !== '') {
                maxQty = parseInt(maxQtyStr);
            }
            let qty = parseInt(qtyInput.value);
            if (isNaN(qty) || qty < 1) {
                alert("الكمية غير صحيحة.");
                return;
            }
            if (qty > maxQty) {
                alert(`الكمية المطلوبة غير متوفرة. المتوفر: ${maxQty}`);
                return;
            }

            // ✅ التحقق من تكرار المنتج ودمج الكميات
            let existingItemIndex = -1;
            if (editingOrder.items) {
                existingItemIndex = editingOrder.items.findIndex(item => item.id === productId);
            } else {
                editingOrder.items = [];
            }

            if (existingItemIndex !== -1) {
                const currentQty = editingOrder.items[existingItemIndex].quantity;
                const newQty = currentQty + qty;
                const availableQty = editingOrder.items[existingItemIndex].maxAvailableQty || maxQty;
                if (newQty > availableQty) {
                    alert(`الكمية الإجمالية المطلوبة تفوق المتوفر (${availableQty}).`);
                    return;
                }
                editingOrder.items[existingItemIndex].quantity = newQty;
            } else {
                editingOrder.items.push({
                    id: productId,
                    name: name,
                    price: price,
                    quantity: qty,
                    image: image,
                    maxAvailableQty: maxQty
                });
            }

            hideProductSelector();
            renderEditOrderItems();
        }

        function renderEditOrderItems() {
            const container = document.getElementById('edit-order-items');
            container.innerHTML = '';
            editingOrder.items.forEach((item, index) => {
                const maxQty = item.maxAvailableQty !== undefined ? item.maxAvailableQty : (item.quantity || Infinity);
                const imgSrc = item.image || 'https://placehold.co/30x30?text=صورة';
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded gap-2';
                div.innerHTML = `
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <img src="${imgSrc}" class="w-6 h-6 object-cover rounded" onerror="this.src='https://placehold.co/30x30?text=لا+صورة'">
                        <span class="text-sm font-medium truncate">${item.name}</span>
                    </div>
                    <div class="flex items-center space-x-1 space-x-reverse">
                        <input type="number" min="1" max="${maxQty}" value="${item.quantity}" 
                               class="order-qty w-12 p-1 border rounded text-center text-xs" 
                               data-index="${index}" data-max="${maxQty}">
                        <input type="number" step="0.01" min="0" value="${item.price}" 
                               class="order-price w-16 p-1 border rounded text-center text-xs" 
                               data-index="${index}">
                        <button type="button" onclick="removeItemFromEdit(${index})" 
                                class="text-red-600 hover:text-red-800 p-1 rounded">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        window.onload = () => {
            checkAuthState();
        };
    </script>
</body>
</html>
